<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handling</title>
    <style>
        @media print {
            body {
                font-size: 10pt;
                padding: 0;
                margin: 0;
            }
            h1 {
                page-break-after: avoid;
                margin-top: 0;
            }
            h2 {
                page-break-after: avoid;
                margin-top: 20pt;
            }
            h3 {
                page-break-after: avoid;
                margin-top: 15pt;
            }
            pre, table, blockquote {
                page-break-inside: avoid;
            }
            p {
                orphans: 3;
                widows: 3;
            }
            .no-print { display: none; }
            hr {
                margin: 15pt 0;
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px;
            color: #333;
            background: #fff;
        }

        h1 {
            color: #1a5276;
            border-bottom: 3px solid #1a5276;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        h2 {
            color: #2874a6;
            border-bottom: 2px solid #aed6f1;
            padding-bottom: 10px;
            margin-top: 40px;
        }

        h3 {
            color: #2e86c1;
            margin-top: 25px;
        }

        code {
            background: #f4f6f7;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }

        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            line-height: 1.4;
        }

        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
        }

        th {
            background: #2874a6;
            color: white;
            padding: 12px;
            text-align: left;
        }

        td {
            border: 1px solid #ddd;
            padding: 10px;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        blockquote {
            border-left: 4px solid #2874a6;
            margin: 20px 0;
            padding: 15px 20px;
            background: #eaf2f8;
            font-style: italic;
        }

        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }

        a {
            color: #2874a6;
        }

        /* Print button */
        .print-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2874a6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .print-btn:hover {
            background: #1a5276;
        }
    </style>
</head>
<body>
    <button class="print-btn no-print" onclick="window.print()">
        Print / Save as PDF
    </button>

    <h1 id="error-handling">Error Handling</h1>
<h2 id="overview">Overview</h2>
<p>This guide covers error handling across all P21 APIs, including HTTP status codes, API-specific error responses, and troubleshooting strategies.</p>
<hr />
<h2 id="http-status-codes">HTTP Status Codes</h2>
<h3 id="success-codes">Success Codes</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>Meaning</th>
<th>When Used</th>
</tr>
</thead>
<tbody>
<tr>
<td>200</td>
<td>OK</td>
<td>Request succeeded</td>
</tr>
<tr>
<td>201</td>
<td>Created</td>
<td>Resource created (POST)</td>
</tr>
<tr>
<td>204</td>
<td>No Content</td>
<td>Request succeeded, no body (DELETE)</td>
</tr>
</tbody>
</table>
<h3 id="client-error-codes">Client Error Codes</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>Meaning</th>
<th>Common Cause</th>
</tr>
</thead>
<tbody>
<tr>
<td>400</td>
<td>Bad Request</td>
<td>Invalid JSON, missing fields, invalid values</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>Invalid/expired token, missing auth header</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden</td>
<td>Insufficient permissions</td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
<td>Invalid endpoint, resource doesn't exist</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed</td>
<td>Wrong HTTP method for endpoint</td>
</tr>
<tr>
<td>408</td>
<td>Request Timeout</td>
<td>Server took too long to respond</td>
</tr>
<tr>
<td>409</td>
<td>Conflict</td>
<td>Resource conflict (concurrent updates)</td>
</tr>
<tr>
<td>422</td>
<td>Unprocessable Entity</td>
<td>Validation failed</td>
</tr>
</tbody>
</table>
<h3 id="server-error-codes">Server Error Codes</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>Meaning</th>
<th>Common Cause</th>
</tr>
</thead>
<tbody>
<tr>
<td>500</td>
<td>Internal Server Error</td>
<td>Server-side error, bug</td>
</tr>
<tr>
<td>502</td>
<td>Bad Gateway</td>
<td>Middleware proxy issue</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable</td>
<td>Server overloaded, maintenance</td>
</tr>
<tr>
<td>504</td>
<td>Gateway Timeout</td>
<td>Backend service timeout</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="authentication-errors">Authentication Errors</h2>
<h3 id="token-endpoint-errors">Token Endpoint Errors</h3>
<p><strong>401 - Invalid Credentials</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;invalid_grant&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;error_description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The user name or password is incorrect.&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>401 - Invalid Consumer Key</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;invalid_client&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;error_description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Client authentication failed.&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>403 - API Scope Not Granted</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;insufficient_scope&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;error_description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Consumer key does not have access to this API.&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="token-troubleshooting">Token Troubleshooting</h3>
<table>
<thead>
<tr>
<th>Issue</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Invalid credentials</td>
<td>Verify username/password in P21</td>
</tr>
<tr>
<td>Token expired</td>
<td>Refresh token or re-authenticate</td>
</tr>
<tr>
<td>Consumer key invalid</td>
<td>Check API Console for correct key</td>
</tr>
<tr>
<td>Missing scope</td>
<td>Add required API scope to consumer key</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="odata-api-errors">OData API Errors</h2>
<h3 id="400-invalid-filter-expression">400 - Invalid Filter Expression</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;400&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Invalid filter expression: &#39;supplier eq 21274&#39;&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Solution</strong>: Check filter syntax. Common issues:
- Missing <code>_id</code> suffix on numeric fields: <code>supplier_id eq 21274</code>
- Wrong operator: Use <code>eq</code>, not <code>=</code>
- Unquoted strings: Use <code>'value'</code> for strings</p>
<h3 id="404-table-not-found">404 - Table Not Found</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;404&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Resource not found: table/invalid_table&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Solution</strong>: Verify table name exists in P21 database.</p>
<h3 id="query-too-complex">Query Too Complex</h3>
<p>Long filter expressions or many joined conditions may fail:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;400&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Query is too complex&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Solution</strong>: Break into multiple smaller queries.</p>
<hr />
<h2 id="transaction-api-errors">Transaction API Errors</h2>
<h3 id="summary-object">Summary Object</h3>
<p>The Transaction API returns a <code>Summary</code> object with success/failure counts:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Transaction 1:: Customer ID is required&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;Results&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Summary&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;Succeeded&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;Failed&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;Other&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Always check <code>Summary.Failed</code> even on HTTP 200 responses.</p>
<h3 id="common-transaction-errors">Common Transaction Errors</h3>
<p><strong>Required Field Missing</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Transaction 1:: customer_id is required&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Invalid Field Value</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Transaction 1:: Invalid value for price_page_type_cd: &#39;InvalidType&#39;&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Field Order Issue</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Transaction 1:: company_id must be set before product_group_id&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Solution</strong>: Check the service definition for required fields and order.</p>
<h3 id="session-pool-contamination">Session Pool Contamination</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Unexpected response window encountered&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Or validation errors on unrelated fields.</p>
<p><strong>Cause</strong>: A previous failed request left a dialog open in the session pool.</p>
<p><strong>Solutions</strong>:
1. Use the async endpoint
2. Implement retry logic with delay
3. Restart the middleware (last resort)</p>
<p>See <a href="07-Session-Pool-Troubleshooting.md">Session Pool Troubleshooting</a> for details.</p>
<hr />
<h2 id="interactive-api-errors">Interactive API Errors</h2>
<h3 id="session-errors">Session Errors</h3>
<p><strong>Session Not Found</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Session not found or expired&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Solution</strong>: Start a new session.</p>
<p><strong>Session Timeout</strong>
Default timeout is typically 6 minutes of inactivity.</p>
<p><strong>Solution</strong>: Keep sessions short, end when done.</p>
<h3 id="window-errors">Window Errors</h3>
<p><strong>Window Not Open</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Window not found&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Solution</strong>: Re-open the window.</p>
<p><strong>Blocked Status</strong></p>
<p>When a response window opens, the API returns:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Blocked&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Events&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="nt">&quot;Name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;windowopened&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;WindowId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">}}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Solution</strong>: Handle the response window before continuing.</p>
<h3 id="field-not-found">Field Not Found</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Field &#39;invalid_field&#39; not found in datawindow &#39;d_form&#39;&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Solution</strong>: Right-click field in P21, select Help &gt; SQL Information to get correct names.</p>
<hr />
<h2 id="entity-api-errors">Entity API Errors</h2>
<h3 id="404-endpoint-not-found">404 - Endpoint Not Found</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Not Found&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Possible Causes</strong>:
- Entity API not enabled
- Wrong endpoint path
- Entity requires specific licensing</p>
<p><strong>Solution</strong>: Check middleware home page for available endpoints.</p>
<h3 id="validation-errors">Validation Errors</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The request is invalid.&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Errors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;CustomerName is required&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;State must be a valid 2-letter code&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Solution</strong>: Check the <code>Errors</code> array for specific issues.</p>
<hr />
<h2 id="python-error-handling">Python Error Handling</h2>
<h3 id="httpx-error-handling">httpx Error Handling</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HTTP Error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">RequestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="transaction-api-error-handling">Transaction API Error Handling</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_transaction_result</span><span class="p">(</span><span class="n">response_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a Transaction API call succeeded.&quot;&quot;&quot;</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">response_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Summary&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">response_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Messages&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Failed&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Usage</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">check_transaction_result</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># Handle failure</span>
    <span class="k">pass</span>
</code></pre></div>

<h3 id="retry-logic">Retry Logic</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="k">def</span><span class="w"> </span><span class="nf">retry_request</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">base_delay</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retry a request with exponential backoff.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">delay</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">raise</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<hr />
<h2 id="debugging-tips">Debugging Tips</h2>
<h3 id="enable-verbose-logging">Enable Verbose Logging</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">httpx_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;httpx&quot;</span><span class="p">)</span>
<span class="n">httpx_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</code></pre></div>

<h3 id="log-requestresponse">Log Request/Response</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Headers: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Body: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">log_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Body: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="check-token-expiration">Check Token Expiration</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_token_expiry</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if token is expired.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Decode without verification (just to read claims)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verify_signature&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exp&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
            <span class="n">exp_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token expires: </span><span class="si">{</span><span class="n">exp_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exp_time</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Token is EXPIRED&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">exp_time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token valid for: </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not decode token: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="common-issues-quick-reference">Common Issues Quick Reference</h2>
<table>
<thead>
<tr>
<th>Issue</th>
<th>API</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>401 on every request</td>
<td>All</td>
<td>Check token, re-authenticate</td>
</tr>
<tr>
<td>307 Redirect</td>
<td>All</td>
<td>Add <code>follow_redirects=True</code></td>
</tr>
<tr>
<td>Request timeout</td>
<td>All</td>
<td>Increase timeout, check network</td>
</tr>
<tr>
<td>"Unexpected window"</td>
<td>Transaction</td>
<td>Use async endpoint, add delays</td>
</tr>
<tr>
<td>Session expired</td>
<td>Interactive</td>
<td>Start new session</td>
</tr>
<tr>
<td>"Blocked" status</td>
<td>Interactive</td>
<td>Handle response window</td>
</tr>
<tr>
<td>404 on table</td>
<td>OData</td>
<td>Verify table name</td>
</tr>
<tr>
<td>404 on entity</td>
<td>Entity</td>
<td>Check if Entity API enabled</td>
</tr>
<tr>
<td>Validation errors</td>
<td>All</td>
<td>Check required fields</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="related">Related</h2>
<ul>
<li><a href="00-Authentication.md">Authentication</a></li>
<li><a href="07-Session-Pool-Troubleshooting.md">Session Pool Troubleshooting</a></li>
<li>API-specific documentation for detailed error handling</li>
</ul>

    <script>
        // Add IDs to headers for TOC linking
        document.querySelectorAll('h2, h3').forEach(function(header) {
            if (!header.id) {
                header.id = header.textContent.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
            }
        });
    </script>
</body>
</html>
